<!DOCTYPE html>
<html>

<head>

  <title>Snap connect test</title>
  <style type="text/css">
    body { padding-top:4rem; } 
    body, p { text-align: center; }
  </style>

</head>

<body>

  <p id="detectingMessage">Detecting...</p>

  <script type="text/javascript">

const snapId = 'npm:mobymask-snap'; 

const snapName = 'MobyMask Anti-Phishing'; 

/* 
 * provider detection
 * 
 * rather than detecting for Flask, we detect for a Snaps-specific 
 * method to determine if the user is running an extension that supports
 * Snaps; this works for both Flask and MetaMask stable 
 * 
 * this is ugly because we do it twice but it seems to be the best way to 
 * get around provider clobbering by both Phantom and Coinbase Wallet and 
 * detect an extension that supports MetaMask Snaps
 * 
 * the only remaining thing to do is figure out what to recommend if a user
 * does not have MetaMask installed... they should not be recommended to 
 * install MetaMask Flask because that is only for developers... they should 
 * be recommended to install MetaMask stable but only when the relevant version 
 * is available 
 */
const getProvider = async () => {
  let mmFound = false; 
  if ('detected' in window.ethereum) {
    for (const provider of window.ethereum.detected) {
      try {
        // Detect snaps support
        await provider.request({
          method: 'wallet_getSnaps',
        });
        // enforces MetaMask as provider 
        window.ethereum.setProvider(provider);

        mmFound = true; 
        return provider;
      } catch {
        // no-op
      }
    }
  }

  if(!mmFound && 'providers' in window.ethereum) { 
    for (const provider of window.ethereum.providers) { 
      try {
        // Detect snaps support
        await provider.request({
          method: 'wallet_getSnaps',
        });
        
        window.ethereum = provider; 

        mmFound = true; 
        return provider;
      } catch {
        // no-op
      }
    }
  }

  return window.ethereum;
};

(async () => { 
  const provider = await getProvider(); 

  const result = await provider.request({ 
    method: 'wallet_getSnaps', 
  }); 

  if(result) { 
    const button = document.createElement("button"); 
    button.id = "connectButton"; 
    button.textContent = "Connect and install the "+snapName+" snap"; 
    button.onclick = async (event) => { 
      event.preventDefault(); 

      try { 
        const result = await provider.request({
          method: 'wallet_requestSnaps', 
          params: 
            {
              [snapId]: { }
            },
        }); 

        if(result) { 

          try { 
            const snaps = await window.ethereum.request({
              method: 'wallet_getSnaps',
            }); 
            if( Object.keys(snaps).includes(snapId) ) { 
              // the snap is installed 
              var successMessage = document.createElement("p"); 
              successMessage.textContent = snapName + " snap installed successfully!"; 
              document.body.appendChild(successMessage); 
              document.getElementById("connectButton").style.display = "none"; 
            }
            else { 
              // the snap was not installed 
            }
          }
          catch { 

          }

        }

      }
      catch { 
        
      }
    }; 
    document.body.appendChild(button); 
    document.getElementById("detectingMessage").style.display = "none"; 
  }

})();

  </script>

</body>

</html>