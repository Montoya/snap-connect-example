<!DOCTYPE html>
<html>

<head>

  <title>Snap connect test</title>
  <style type="text/css">
    body { padding-top:4rem; } 
    body, p { text-align: center; }
  </style>

</head>

<body>

  <p id="detectingMessage">Detecting...</p>

  <script type="text/javascript" src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

  <script type="text/javascript">

var snapId = 'npm:mobymask-snap'; 

/* 
 * environment detection
 * 
 * this works for local testing and production deployment
 * at the very least you can use GitHub pages to make a production 
 * deployment and allow users to install your snap from npm
 */
if (["localhost", "127.0.0.1", ""].includes(window.location.hostname) ) {
  snapId = 'local:http://localhost:8080';
  // note that this will only work if the snap is running locally on 8080!
}

const snapName = 'MobyMask Anti-Phishing'; 

const MMSDK = new MetaMaskSDK()

const provider = MMSDK.getProvider() // You can also access via window.ethereum

(async () => { 
  const result = await provider.request({ 
    method: 'wallet_getSnaps', 
  }); 

  if(result) { 
    const button = document.createElement("button"); 
    button.id = "connectButton"; 
    button.textContent = "Connect and install the "+snapName+" snap"; 
    button.onclick = async (event) => { 
      event.preventDefault(); 

      try { 
        const result = await provider.request({
          method: 'wallet_requestSnaps', 
          params: 
            {
              [snapId]: { }
            },
        }); 

        if(result) { 

          try { 
            const snaps = await window.ethereum.request({
              method: 'wallet_getSnaps',
            }); 
            if( Object.keys(snaps).includes(snapId) ) { 
              // the snap is installed 
              const successMessage = document.createElement("p"); 
              successMessage.textContent = snapName + " snap installed successfully!"; 
              document.body.appendChild(successMessage); 
              document.getElementById("connectButton").style.display = "none"; 
            }
            else { 
              // the snap was not installed 
            }
          }
          catch { 

          }

        }

      }
      catch { 
        
      }
    }; 
    document.body.appendChild(button); 
    document.getElementById("detectingMessage").style.display = "none"; 
  }
  else { 
    const notFoundMessage = document.createElement("p"); 
    notFoundMessage.textContent = "You do not have the MetaMask Snaps API."; 
    document.body.appendChild(notFoundMessage); 
    document.getElementById("detectingMessage").style.display = "none"; 
  }

})();

  </script>

</body>

</html>