<!DOCTYPE html>
<html>
<head>
  <title>Snap connect test</title>
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz@9..40&display=swap" rel="stylesheet">
  <style type="text-css">
    body { 
      font-family:'DM Sans', sans-serif; 
    }
    #page { 
      width:600px; 
      margin:0 auto; 
    }
  </style>
</head>
<body style="background-color:#224">

  <div id="page" class="text-light">
    <h1 class="h3">Detected Wallets</h1>
    <div class="loading">Detecting...</div>
  </div>

  <p id="detectingMessage">Detecting...</p>

  <script type="text/javascript">

const snapId = 'npm:@consensys/starknet-snap';

const snapName = 'Starknet'; 

/* 
 * Use EIP-6963 to detect MetaMask
 */

function MetaMaskFound(provider) { 

  const button = document.createElement("button"); 
  button.id = "connectButton"; 
  button.textContent = "Connect and install the "+snapName+" snap"; 
  button.onclick = async (event) => { 
    event.preventDefault(); 

    try { 
      const result = await provider.request({
        method: 'wallet_requestSnaps', 
        params: 
          {
            [snapId]: { }
          },
      }); 

      if(result) { 

        try { 
          const snaps = await provider.request({
            method: 'wallet_getSnaps',
          }); 
          if( Object.keys(snaps).includes(snapId) ) { 
            // the snap is installed 
            var successMessage = document.createElement("p"); 
            successMessage.textContent = snapName + " snap installed successfully!"; 
            document.body.appendChild(successMessage); 
            document.getElementById("connectButton").style.display = "none"; 
          }
          else { 
            // the snap was not installed 
          }
        }
        catch { 

        }

      }

    }
    catch { 
      
    }
  }; 
  document.body.appendChild(button); 
  document.getElementById("detectingMessage").style.display = "none"; 

}

window.onload = function() {

  window.addEventListener(
    "eip6963:announceProvider",
    (event) => {
      /* event.detail contains the discovered provider interface */ 
      const providerDetail = event.detail; 
      
      /* 
       * Ideally you would take one of these cases and use it for your needs,
       * or set up a conditional that takes any of these possibilities, 
       * or prompt the user to choose which MetaMask flavor they want to use, 
       * in case they have multiple MetaMask extensions installed at the same time
       * 
       * In this crude example, all 3 providers can run in parallel, which is surreal
       */

      if(providerDetail.info.name == "MetaMask" && providerDetail.info.rdns == "io.metamask") { 
        /* this is MetaMask stable */
        MetaMaskFound(providerDetail.provider); 
      }
      else if(providerDetail.info.name == "MetaMask" && providerDetail.info.rdns == "io.metamask.flask") { 
        /* this is MetaMask Flask */ 
        MetaMaskFound(providerDetail.provider); 
      }
      else if(providerDetail.info.name == "MetaMask Institutional" && providerDetail.info.rdns == "io.metamask.mmi") { 
        /* this is MetaMask Institutional */ 
        MetaMaskFound(providerDetail.provider); 
      }
    }
  );

  window.dispatchEvent(new Event("eip6963:requestProvider"));

  setTimeout(() => { 
    if("none"!==document.getElementById('detectingMessage').style.display) { 
      /* Assume MetaMask was not detected */
      document.getElementById('detectingMessage').textContent = "MetaMask was not found"; 
    }
  }, 1000)

}

  </script>

</body>

</html>