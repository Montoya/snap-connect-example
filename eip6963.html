<!DOCTYPE html>
<html>

<head>

  <title>Snap connect test</title>
  <style type="text/css">
    body { padding-top:4rem; } 
    body, p { text-align: center; }
  </style>

</head>

<body>

  <p id="detectingMessage">Detecting...</p>

  <script type="text/javascript">

const snapId = 'npm:@consensys/starknet-snap';

const snapName = 'Starknet'; 

/* 
 * Use EIP-6963 to detect MetaMask
 */

function MetaMaskFound(provider) { 

  const button = document.createElement("button"); 
  button.id = "connectButton"; 
  button.textContent = "Connect and install the "+snapName+" snap"; 
  button.onclick = async (event) => { 
    event.preventDefault(); 

    try { 
      const result = await provider.request({
        method: 'wallet_requestSnaps', 
        params: 
          {
            [snapId]: { }
          },
      }); 

      if(result) { 

        try { 
          const snaps = await provider.request({
            method: 'wallet_getSnaps',
          }); 
          if( Object.keys(snaps).includes(snapId) ) { 
            // the snap is installed 
            var successMessage = document.createElement("p"); 
            successMessage.textContent = snapName + " snap installed successfully!"; 
            document.body.appendChild(successMessage); 
            document.getElementById("connectButton").style.display = "none"; 
          }
          else { 
            // the snap was not installed 
          }
        }
        catch { 

        }

      }

    }
    catch { 
      
    }
  }; 
  document.body.appendChild(button); 
  document.getElementById("detectingMessage").style.display = "none"; 

}

window.onload = function() {

  window.addEventListener(
    "eip6963:announceProvider",
    (event) => {
      /* event.detail contains the discovered provider interface */ 
      const providerDetail = event.detail; 
      
      /* 
       * Ideally you would take one of these cases and use it for your needs
       * Or set up a conditional that takes any of these possibilities 
       * 
       * In this example, all 3 providers can run in parallel, which is surreal
       */

      if(providerDetail.info.name == "MetaMask" && providerDetail.info.rdns == "io.metamask") { 
        /* this is MetaMask stable */
        MetaMaskFound(providerDetail.provider); 
      }
      else if(providerDetail.info.name == "MetaMask" && providerDetail.info.rdns == "io.metamask.flask") { 
        /* this is MetaMask Flask */ 
        MetaMaskFound(providerDetail.provider); 
      }
      else if(providerDetail.info.name == "MetaMask Institutional" && providerDetail.info.rdns == "io.metamask.mmi") { 
        /* this is MetaMask Institutional */ 
        MetaMaskFound(providerDetail.provider); 
      }
    }
  );

  window.dispatchEvent(new Event("eip6963:requestProvider"));

  setTimeout(() => { 
    if("none"!==document.getElementById('detectingMessage').style.display) { 
      /* Assume MetaMask was not detected */
      document.getElementById('detectingMessage').textContent = "MetaMask was not found"; 
    }
  }, 1000)

}

  </script>

</body>

</html>